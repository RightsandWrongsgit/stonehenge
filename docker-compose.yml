version: '3.7'

services:

  traefik:
    image: traefik:v2.1
    container_name: "${PREFIX}-traefik"
    restart: unless-stopped
    command: |-
      --providers.docker.network="${PREFIX}-network"
      --providers.docker.defaultRule="${DOCKER_DOMAIN}"
      --providers.docker.tls.cert="/ssl/${DOCKER_DOMAIN}.crt"
      --providers.docker.tls.key="/ssl/${DOCKER_DOMAIN}.key"
    labels:
      traefik.enable: true
      traefik.http.routers.traefik.rule: "Host(`traefik.${DOCKER_DOMAIN}`)"
      traefik.http.services.traefik.loadbalancer.server.port: 8080
      treafik.http.routers.dashboard.service: api@internal
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # So that Traefik can listen to the Docker events
      - ./traefik.yml:/traefik.yml:ro
      - ./certs:/ssl # mkcert certs

  portainer:
    image: portainer/portainer:1.23.0
    container_name: "${PREFIX}-portainer"
    restart: unless-stopped
    command: |-
      --no-auth -H unix:///var/run/docker.sock
      --logo "${LOGO_URL}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      traefik.enable: true
      traefik.http.services.portainer.loadbalancer.server.port: 9000
      traefik.http.routers.portainer.rule: "Host(`portainer.${DOCKER_DOMAIN}`)"
      traefik.http.routers.portainer.entrypoints: https
      traefik.http.routers.portainer.tls: true

#  mailhog:
#    image: mailhog/mailhog
#    container_name: "${PREFIX}-mailhog"
#    restart: unless-stopped
#    labels:
#      traefik.enable: true
#      traefik.backend: mailhog
#      traefik.port: 8025
#      traefik.frontend.rule: "Host:mailhog.${DOCKER_DOMAIN}"
#      traefik.frontend.redirect.entryPoint: https
#
#  ssh-agent:
#    image: amazeeio/ssh-agent
#    container_name: "${PREFIX}-ssh-agent"
#    restart: unless-stopped
#    volumes:
#      - ~/.ssh:/ssh
#      - ssh:/tmp/amazeeio_ssh-agent/

#  catchall:
#    image: nginx:1.17-alpine
#    container_name: "${PREFIX}-catchall"
#    restart: unless-stopped
#    volumes:
#      - ./catchall/nginx.conf:/etc/nginx/conf.d/default.conf:ro
#      - ./catchall/index.html:/usr/share/nginx/html/index.html:ro
#    labels:
#      traefik.enable: true
#      traefik.backend: catchall
#      traefik.frontend.rule: "HostRegexp:{catchall:.*}"
#      traefik.frontend.priority: 1
#      traefik.frontend.redirect.entryPoint: https

networks:
  default:
    name: "${PREFIX}-network"
    external: true

volumes:
  ssh:
    name: "${PREFIX}-ssh"
    external: true
